<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radio Browser</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
    .container { max-width: 900px; }
    .scrollable-list { max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .station-item { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
    .station-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .play-button, .save-button, .remove-button, .visit-website-button { transition: background-color 0.2s, transform 0.1s; }
    .play-button:hover, .save-button:hover, .remove-button:hover, .visit-website-button:hover { transform: scale(1.05); }
</style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 min-h-screen flex items-center justify-center">

<div class="container bg-white p-6 sm:p-10 rounded-3xl shadow-2xl w-full">
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-2">Ricerca Radio Online</h1>
    <p class="text-center text-gray-500 mb-8">Cerca e salva le tue stazioni radio preferite.</p>
    
    <audio id="audio-player" class="w-full my-4 rounded-xl hidden" controls autoplay></audio>

    <div id="player-info" class="bg-indigo-100 text-indigo-800 p-4 rounded-xl mb-6 shadow-inner hidden">
        <h3 class="font-bold text-lg" id="current-station-name"></h3>
        <div class="flex flex-wrap gap-2 text-xs mt-2 text-indigo-700">
            <span id="player-codec" class="bg-indigo-200 py-1 px-2 rounded-full"></span>
            <span id="player-bitrate" class="bg-indigo-200 py-1 px-2 rounded-full"></span>
            <span id="player-language" class="bg-indigo-200 py-1 px-2 rounded-full"></span>
            <span id="player-tags" class="bg-indigo-200 py-1 px-2 rounded-full"></span>
            <a id="player-homepage-link" href="#" target="_blank" class="bg-indigo-200 py-1 px-2 rounded-full hover:underline hidden">Homepage</a>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <select id="search-type-select" class="p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-indigo-500 transition-all shadow-sm">
            <option value="name">Nome</option>
            <option value="country">Paese</option>
            <option value="tag">Tag</option>
        </select>
        <input type="text" id="search-input" placeholder="Inserisci il termine di ricerca..." class="flex-1 p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-indigo-500 transition-all shadow-sm">
        <button id="search-button" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors">Cerca</button>
    </div>

    <div id="status-message" class="text-center text-sm text-gray-500 mb-4 hidden"></div>

    <div id="results-container" class="mb-8">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
            <h2 class="text-2xl font-semibold text-indigo-600">Risultati della Ricerca (<span id="results-count">0</span>)</h2>
            <div class="flex flex-col sm:flex-row items-center gap-2 mt-2 sm:mt-0">
                <div class="flex items-center gap-2">
                     <span class="text-sm text-gray-600">Ordina per:</span>
                     <select id="sort-select" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                        <option value="name">Nome</option>
                        <option value="country">Paese</option>
                     </select>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">Filtra per Paese:</span>
                    <select id="country-filter-select" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                        <option value="">Tutti i Paesi</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="results-list" class="bg-gray-50 rounded-xl p-4 scrollable-list">
            <p class="text-gray-400 text-center">I risultati appariranno qui...</p>
        </div>
    </div>

    <div id="saved-stations-container">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
            <h2 class="text-2xl font-semibold text-indigo-600">Stazioni Salvate (<span id="saved-count">0</span>)</h2>
            <div class="flex flex-col sm:flex-row items-center gap-2 mt-2 sm:mt-0">
                <span class="text-sm text-gray-600">Ordina per:</span>
                <select id="saved-sort-select" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none">
                    <option value="name">Nome</option>
                    <option value="country">Paese</option>
                </select>
                <span class="text-sm text-gray-600">Filtra per Paese:</span>
                <select id="saved-country-filter-select" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                    <option value="">Tutti i Paesi</option>
                </select>
            </div>
        </div>
        <div class="mt-4 flex flex-wrap gap-2">
            <button id="export-button" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-gray-500 transition-colors text-sm">Esporta Lista</button>
            <button id="import-button" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-gray-500 transition-colors text-sm">Importa Lista</button>
            <input type="file" id="file-input" class="hidden" accept=".json">
        </div>
        <div id="saved-stations-list" class="bg-gray-50 rounded-xl p-4 scrollable-list">
            <p class="text-gray-400 text-center">Nessuna stazione salvata.</p>
        </div>
    </div>
</div>

<!-- Modale per Edit Station -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold text-indigo-700 mb-4">Modifica Stazione</h2>
        <form id="edit-form" class="flex flex-col gap-3">
            <input type="text" id="edit-name" placeholder="Nome stazione" class="p-3 border rounded-lg focus:outline-none focus:border-indigo-500">
            <input type="text" id="edit-url" placeholder="URL streaming" class="p-3 border rounded-lg focus:outline-none focus:border-indigo-500">
            <input type="text" id="edit-homepage" placeholder="Homepage" class="p-3 border rounded-lg focus:outline-none focus:border-indigo-500">
            <input type="text" id="edit-tags" placeholder="Tags (separati da virgola)" class="p-3 border rounded-lg focus:outline-none focus:border-indigo-500">
            <div class="flex justify-end gap-2 mt-2">
                <button type="button" id="edit-cancel" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500">Annulla</button>
                <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">Salva</button>
            </div>
        </form>
    </div>
</div>

<script>
let searchResults = [];
let savedStations = [];
let currentPlayingStationId = null;
let editingStationUuid = null;

// --- Funzioni utility ---
function showStatus(message, isHidden = false) {
    const statusElement = document.getElementById('status-message');
    statusElement.textContent = message;
    statusElement.classList.toggle('hidden', isHidden);
}

function sortStations(stations, sortBy) {
    return stations.sort((a, b) => {
        let aValue = a[sortBy] || '';
        let bValue = b[sortBy] || '';
        return aValue.localeCompare(bValue);
    });
}

function updateAllPlayButtonTexts() {
    document.querySelectorAll('.play-button').forEach(btn => {
        const stationDiv = btn.closest('.station-item');
        const uuid = stationDiv.getAttribute('data-station-uuid');
        btn.textContent = (currentPlayingStationId === uuid && !document.getElementById('audio-player').paused) ? '⏸️ Pausa' : '▶️ Play';
    });
}

// --- Render Risultati ---
function renderSearchResults() {
    const resultsList = document.getElementById('results-list');
    const resultsCountElement = document.getElementById('results-count');
    const countryFilterSelect = document.getElementById('country-filter-select');

    resultsList.innerHTML = '';

    // Popola il menu a tendina dei paesi
    const countries = [...new Set(searchResults.map(station => station.country))].sort();
    const selectedCountry = countryFilterSelect.value;
    countryFilterSelect.innerHTML = '<option value="">Tutti i Paesi</option>';
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilterSelect.appendChild(option);
    });
    countryFilterSelect.value = selectedCountry;

    const filteredResults = searchResults.filter(station => {
        return !selectedCountry || station.country === selectedCountry;
    });

    if (filteredResults.length === 0) {
        resultsList.innerHTML = '<p class="text-gray-400 text-center">Nessuna stazione trovata.</p>';
        resultsCountElement.textContent = '0';
        return;
    }

    const sortBy = document.getElementById('sort-select').value;
    const sortedStations = sortStations([...filteredResults], sortBy);
    resultsCountElement.textContent = sortedStations.length;

    sortedStations.forEach(station => {
        const item = document.createElement('div');
        item.className = 'station-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 my-2 bg-white rounded-lg shadow-sm hover:shadow-md';
        item.setAttribute('data-station-uuid', station.stationuuid);
        item.innerHTML = `
            <div class="flex items-center">
                <img src="${station.favicon}" onerror="this.src='https://placehold.co/40x40/f3f4f6/1f2937?text=...'" class="w-10 h-10 rounded-full mr-4 object-cover" alt="Icona radio">
                <img src="https://flagcdn.com/w20/${(station.countrycode || '').toLowerCase()}.png" onerror="this.src='https://placehold.co/20x15/f3f4f6/1f2937?text=...'" class="w-5 h-4 mr-2" alt="Bandiera">
                <div>
                    <h3 class="font-bold text-gray-800">${station.name}</h3>
                    <p class="text-sm text-gray-500">${station.country}, ${station.tags}</p>
                </div>
            </div>
            <div class="mt-2 sm:mt-0 flex gap-2">
                <button class="play-button bg-yellow-400 text-gray-800 font-semibold py-2 px-3 rounded-lg text-sm flex items-center justify-center" title="Riproduci stazione"></button>
                <a href="${station.homepage || '#'}" target="_blank" class="visit-website-button ${station.homepage ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-400 cursor-not-allowed'} text-white font-semibold py-2 px-3 rounded-lg text-sm flex items-center justify-center" title="Visita il sito web">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <title>Sito Web</title>
                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                    </svg>
                </a>
                <button class="save-button bg-green-500 text-white font-semibold py-2 px-3 rounded-lg text-sm hover:bg-green-600 transition-colors flex items-center justify-center" title="Salva stazione"></button>
            </div>
        `;

        item.querySelector('.play-button').addEventListener('click', () => {
            const audioPlayer = document.getElementById('audio-player');
            if (currentPlayingStationId === station.stationuuid) {
                if (audioPlayer.paused) audioPlayer.play();
                else audioPlayer.pause();
            } else {
                audioPlayer.src = station.url;
                audioPlayer.classList.remove('hidden');
                audioPlayer.play();
                currentPlayingStationId = station.stationuuid;

                document.getElementById('player-info').classList.remove('hidden');
                document.getElementById('current-station-name').textContent = station.name;
                document.getElementById('player-codec').textContent = `Codec: ${station.codec || 'N/A'}`;
                document.getElementById('player-bitrate').textContent = `Bitrate: ${station.bitrate ? station.bitrate + ' kbps' : 'N/A'}`;
                document.getElementById('player-language').textContent = `Lingua: ${station.language || 'N/A'}`;
                document.getElementById('player-tags').textContent = `Tags: ${station.tags || 'N/A'}`;

                const homepageLink = document.getElementById('player-homepage-link');
                if (station.homepage) {
                    homepageLink.href = station.homepage;
                    homepageLink.classList.remove('hidden');
                } else homepageLink.classList.add('hidden');
            }
            updateAllPlayButtonTexts();
        });

        item.querySelector('.save-button').addEventListener('click', () => {
            const isAlreadySaved = savedStations.some(s => s.stationuuid === station.stationuuid);
            if (isAlreadySaved) {
                showStatus('Questa stazione è già salvata!', false);
                setTimeout(() => showStatus('', true), 3000);
                return;
            }
            savedStations.push(station);
            localStorage.setItem('savedStations', JSON.stringify(savedStations));
            renderSavedStations();
            showStatus('Stazione salvata con successo!', false);
            setTimeout(() => showStatus('', true), 3000);
        });

        resultsList.appendChild(item);
    });

    updateAllPlayButtonTexts();
}

// --- Carica Stazioni Salvate ---
function renderSavedStations() {
    const savedList = document.getElementById('saved-stations-list');
    const savedCount = document.getElementById('saved-count');
    const countryFilterSelect = document.getElementById('saved-country-filter-select');

    savedList.innerHTML = '';
    const countries = [...new Set(savedStations.map(s => s.country))].sort();
    const selectedCountry = countryFilterSelect.value;
    countryFilterSelect.innerHTML = '<option value="">Tutti i Paesi</option>';
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilterSelect.appendChild(option);
    });
    countryFilterSelect.value = selectedCountry;

    let filteredStations = savedStations;
    if (selectedCountry) filteredStations = filteredStations.filter(s => s.country === selectedCountry);

    const sortBy = document.getElementById('saved-sort-select').value;
    filteredStations = sortStations(filteredStations, sortBy);

    if (filteredStations.length === 0) savedList.innerHTML = '<p class="text-gray-400 text-center">Nessuna stazione salvata.</p>';

    filteredStations.forEach(station => {
        const item = document.createElement('div');
        item.className = 'station-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 my-2 bg-white rounded-lg shadow-sm hover:shadow-md';
        item.setAttribute('data-station-uuid', station.stationuuid);
        item.innerHTML = `
            <div class="flex items-center">
                <img src="${station.favicon}" onerror="this.src='https://placehold.co/40x40/f3f4f6/1f2937?text=...'" class="w-10 h-10 rounded-full mr-4 object-cover" alt="Icona radio">
                <img src="https://flagcdn.com/w20/${(station.countrycode || '').toLowerCase()}.png" onerror="this.src='https://placehold.co/20x15/f3f4f6/1f2937?text=...'" class="w-5 h-4 mr-2" alt="Bandiera">
                <div>
                    <h3 class="font-bold text-gray-800">${station.name}</h3>
                    <p class="text-sm text-gray-500">${station.country}, ${station.tags}</p>
                </div>
            </div>
            <div class="mt-2 sm:mt-0 flex gap-2">
                <button class="play-button bg-yellow-400 text-gray-800 font-semibold py-2 px-3 rounded-lg text-sm flex items-center justify-center" title="Riproduci stazione"></button>
                <a href="${station.homepage || '#'}" target="_blank" class="visit-website-button ${station.homepage ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-400 cursor-not-allowed'} text-white font-semibold py-2 px-3 rounded-lg text-sm flex items-center justify-center" title="Visita il sito web">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <title>Sito Web</title>
                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                    </svg>
                </a>
                <button class="remove-button bg-red-500 text-white font-semibold py-2 px-3 rounded-lg text-sm hover:bg-red-600 transition-colors flex items-center justify-center" title="Rimuovi stazione"></button>
                <button class="edit-button bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg text-sm hover:bg-gray-600 transition-colors flex items-center justify-center" title="Modifica stazione">✏️</button>
            </div>
        `;

        item.querySelector('.play-button').addEventListener('click', () => {
            const audioPlayer = document.getElementById('audio-player');
            if (currentPlayingStationId === station.stationuuid) {
                if (audioPlayer.paused) audioPlayer.play();
                else audioPlayer.pause();
            } else {
                audioPlayer.src = station.url;
                audioPlayer.classList.remove('hidden');
                audioPlayer.play();
                currentPlayingStationId = station.stationuuid;

                document.getElementById('player-info').classList.remove('hidden');
                document.getElementById('current-station-name').textContent = station.name;
                document.getElementById('player-codec').textContent = `Codec: ${station.codec || 'N/A'}`;
                document.getElementById('player-bitrate').textContent = `Bitrate: ${station.bitrate ? station.bitrate + ' kbps' : 'N/A'}`;
                document.getElementById('player-language').textContent = `Lingua: ${station.language || 'N/A'}`;
                document.getElementById('player-tags').textContent = `Tags: ${station.tags || 'N/A'}`;

                const homepageLink = document.getElementById('player-homepage-link');
                if (station.homepage) {
                    homepageLink.href = station.homepage;
                    homepageLink.classList.remove('hidden');
                } else homepageLink.classList.add('hidden');
            }
            updateAllPlayButtonTexts();
        });

        item.querySelector('.remove-button').addEventListener('click', () => {
            savedStations = savedStations.filter(s => s.stationuuid !== station.stationuuid);
            localStorage.setItem('savedStations', JSON.stringify(savedStations));
            renderSavedStations();
        });

        item.querySelector('.edit-button').addEventListener('click', () => {
            editingStationUuid = station.stationuuid;
            document.getElementById('edit-name').value = station.name;
            document.getElementById('edit-url').value = station.url;
            document.getElementById('edit-homepage').value = station.homepage || '';
            document.getElementById('edit-tags').value = station.tags || '';
            document.getElementById('edit-modal').classList.remove('hidden');
        });

        savedList.appendChild(item);
    });

    savedCount.textContent = filteredStations.length;
    updateAllPlayButtonTexts();
}

// --- Inizializzazione ---
window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('savedStations');
    if (saved) savedStations = JSON.parse(saved);

    renderSavedStations();
});

// --- Eventi ricerca ---
document.getElementById('search-button').addEventListener('click', searchStations);
document.getElementById('sort-select').addEventListener('change', renderSearchResults);
document.getElementById('country-filter-select').addEventListener('change', renderSearchResults);
document.getElementById('saved-sort-select').addEventListener('change', renderSavedStations);
document.getElementById('saved-country-filter-select').addEventListener('change', renderSavedStations);

// --- Modale edit ---
document.getElementById('edit-cancel').addEventListener('click', () => {
    document.getElementById('edit-modal').classList.add('hidden');
});

document.getElementById('edit-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const station = savedStations.find(s => s.stationuuid === editingStationUuid);
    if (!station) return;
    station.name = document.getElementById('edit-name').value;
    station.url = document.getElementById('edit-url').value;
    station.homepage = document.getElementById('edit-homepage').value;
    station.tags = document.getElementById('edit-tags').value;
    localStorage.setItem('savedStations', JSON.stringify(savedStations));
    renderSavedStations();
    document.getElementById('edit-modal').classList.add('hidden');
});

// --- Esporta / Importa ---
document.getElementById('export-button').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(savedStations, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'stazioni_radio.json';
    a.click(); URL.revokeObjectURL(url);
});

document.getElementById('import-button').addEventListener('click', () => document.getElementById('file-input').click());
document.getElementById('file-input').addEventListener('change', (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            const imported = JSON.parse(evt.target.result);
            if (Array.isArray(imported)) {
                savedStations = imported;
                localStorage.setItem('savedStations', JSON.stringify(savedStations));
                renderSavedStations();
            }
        } catch(err){ alert("Errore nel file JSON."); }
    };
    reader.readAsText(file);
});

// --- Funzione di ricerca stazioni ---
async function searchStations() {
    const term = document.getElementById('search-input').value.trim();
    const type = document.getElementById('search-type-select').value;
    if (!term) { showStatus('Inserisci un termine di ricerca!', false); return; }

    showStatus('Caricamento...', false);

    let url = `https://de1.api.radio-browser.info/json/stations/search?${type}=${encodeURIComponent(term)}&limit=50`;
    try {
        const res = await fetch(url);
        searchResults = await res.json();
        renderSearchResults();
        showStatus('', true);
    } catch(err){
        showStatus('Errore durante la ricerca.', false);
        console.error(err);
    }
}
</script>
</body>
</html>
